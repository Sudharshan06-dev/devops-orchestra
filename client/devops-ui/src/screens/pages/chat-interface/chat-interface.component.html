<div class="chat-wrapper">
  <!-- Compact Header -->
  <div class="chat-header">
    <div class="header-content">
      <div class="chat-title">
        <span class="main-title">Aivina</span>
        <span class="status-indicator" [class.online]="isOnline"></span>
      </div>
      <div class="header-actions">
        <button class="btn-new-chat" (click)="startNewChat()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14m-7-7h14" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Collapsible Chat History -->
  <div class="chat-history" *ngIf="pastChatHistory.length > 0 && showHistory">
    <div class="history-container">
      <div *ngFor="let currentMessage of pastChatHistory;" (click)="loadChatHistory(currentMessage.chat_id)"
        [class.active]="currentMessage.chat_id === chatId" class="chat-history-item">
        <div class="session-title">{{ currentMessage.chat_id }}</div>
        <button class="btn-delete-session"
          (click)="deleteChatHistory(currentMessage.chat_id); $event.stopPropagation()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Toggle History Button -->
  <button class="btn-toggle-history" *ngIf="pastChatHistory.length > 0" (click)="showHistory = !showHistory">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline [attr.points]="showHistory ? '18 15 12 9 6 15' : '6 9 12 15 18 9'" />
    </svg>
  </button>

  <!-- Expanded Chat Messages -->
  <div class="chat-messages" #scrollContainer>
    <div class="messages-container">
      <!-- Minimal Welcome Message -->
      <div class="welcome-message" *ngIf="currentMessages.length === 0">
        <h3>Welcome to Aivina</h3>
        <p>Your Infrastructure Assistant</p>
      </div>

      <div *ngFor="let message of currentMessages; let i = index; trackBy: trackByMessageIndex" class="message-wrapper">
        <div [ngClass]="{'user-message': message.role === 'user', 'ai-message': message.role === 'assistant'}">
          <div class="message-avatar" *ngIf="message.role === 'assistant'">
            <div class="ai-avatar">ðŸ¤–</div>
          </div>
          <div class="message-avatar" *ngIf="message.role === 'user'">
            <div class="ai-avatar">{{userName}}</div>
          </div>
          <div class="message-content">
            <div class="message-text">
              <markdown [data]="message.content"></markdown>
            </div>
            <div class="message-footer">
              <div class="message-time">{{ getMessageTime(i) }}</div>
              <div class="message-actions" *ngIf="message.role === 'assistant'">
                <button class="action-btn" (click)="copyMessage(message.content)" title="Copy">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" />
                  </svg>
                </button>
                <button class="action-btn" (click)="regenerateResponse(i)" title="Regenerate">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4a9 9 0 01-14.85 8.36L23 14" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" *ngIf="isTyping">
        <div class="ai-avatar small">ðŸ¤–</div>
        <div class="typing-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Input Area -->
<div class="chat-input">
  <div class="input-container">
    
    <!-- ðŸ“ Enhanced Upload Button -->
    <input type="file"
           id="envUpload"
           accept=".env,.txt"
           style="display: none"
           (change)="handleEnvFileUpload($event)" />
    
    <div class="upload-wrapper">
      <button class="btn-upload" 
              (click)="triggerFileUpload()" 
              title="Upload .env file"
              [class.has-file]="uploadedFileName">
        <svg class="upload-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        <span class="upload-text" *ngIf="!uploadedFileName">.env</span>
      </button>
      
      <!-- File name indicator -->
      <div class="file-indicator" *ngIf="uploadedFileName">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" />
          <polyline points="13 2 13 9 20 9" />
        </svg>
        <span class="file-name">{{ uploadedFileName }}</span>
        <button class="remove-file" (click)="removeFile($event)" title="Remove file">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Text Input -->
    <textarea [(ngModel)]="userInput"
              placeholder="Ask anything about your infrastructure..."
              (keydown)="handleKeyDown($event)"
              (input)="onInputChange()"
              [rows]="1"
              #messageInput></textarea>

    <!-- Send Button -->
    <button class="btn-send" (click)="sendMessage()" [disabled]="!canSend()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="22" y1="2" x2="11" y2="13" />
        <polygon points="22,2 15,22 11,13 2,9" />
      </svg>
    </button>
  </div>
</div>
</div>